<!-- Diálogo de Detalhes do Gato -->
<p-dialog 
  [(visible)]="visible" 
  [modal]="true" 
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="tdg-modal"
  maskStyleClass="tdg-modal-mask"
  [style]="{width: '90vw', maxWidth: '800px'}"
  header="Perfil do Gato"
  (onHide)="onHide()">
  
  <div class="cat-profile-container" *ngIf="cat">
    <!-- Cabeçalho do perfil -->
    <div class="cat-profile-header">
      <div class="cat-profile-image">
        <img 
          [src]="cat.photoUrl || getDefaultImage()" 
          [alt]="cat.name"
          (error)="onImageError($event)"
          class="profile-image">
        
        <!-- Status de adoção -->
        <div class="profile-status">
          <div class="status-badge" [class]="cat.adoptionStatus.toLowerCase().replace('_', '-')">
            <i class="fas" [class]="getAdoptionStatusIcon(cat.adoptionStatus)"></i>
            <span>{{ getAdoptionStatusText(cat.adoptionStatus) }}</span>
          </div>
        </div>
      </div>
      
      <div class="cat-profile-info">
        <h2 class="cat-profile-name">{{ cat.name }}</h2>
        <div class="cat-profile-age">{{ getAge(cat.birthDate) }}</div>
        
        <div class="quick-info">
          <div class="quick-info-item">
            <i class="fas fa-palette"></i>
            <span>{{ getColorLabel(cat.color) }}</span>
          </div>
          <div class="quick-info-item">
            <i class="fas" [class.fa-mars]="cat.sex === 'MALE'" [class.fa-venus]="cat.sex === 'FEMALE'"></i>
            <span>{{ getSexLabel(cat.sex) }}</span>
          </div>
        </div>
      </div>
    </div>


    <!-- Abas de informações -->
    <div class="tab-container">
      <!-- Navegação das abas -->
      <div class="tab-nav">
        <button 
          class="tab-btn" 
          [class.active]="activeTab === 'info'"
          (click)="activeTab = 'info'">
          <i class="fas fa-info-circle"></i>
          Informações
        </button>
        <button 
          class="tab-btn" 
          [class.active]="activeTab === 'notes'"
          (click)="activeTab = 'notes'">
          <i class="fas fa-file-edit"></i>
          Anotações
        </button>
        <button 
          *ngIf="cat?.adoptionStatus !== 'NAO_ADOTADO'"
          class="tab-btn" 
          [class.active]="activeTab === 'adopter'"
          (click)="activeTab = 'adopter'">
          <i class="fas fa-user-heart"></i>
          Adotante
        </button>
      </div>

      <!-- Conteúdo das abas -->
      <div class="tab-content">
        <!-- Aba de Informações Detalhadas -->
        <div *ngIf="activeTab === 'info'" class="tab-pane">
          <div class="cat-profile-details">
            <div class="details-grid">
              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas fa-birthday-cake"></i>
                  Data de Nascimento
                </div>
                <div class="detail-value">{{ formatDate(cat.birthDate) }}</div>
              </div>

              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas fa-calendar-plus"></i>
                  Entrada no Abrigo
                </div>
                <div class="detail-value">{{ formatDate(cat.shelterEntryDate) }}</div>
              </div>

              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas fa-clock"></i>
                  Tempo no Abrigo
                </div>
                <div class="detail-value">{{ getDaysInShelter(cat.shelterEntryDate) }} dias</div>
              </div>

              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas fa-palette"></i>
                  Cor
                </div>
                <div class="detail-value">{{ getColorLabel(cat.color) }}</div>
              </div>

              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas" [class.fa-mars]="cat.sex === 'MALE'" [class.fa-venus]="cat.sex === 'FEMALE'"></i>
                  Sexo
                </div>
                <div class="detail-value">{{ getSexLabel(cat.sex) }}</div>
              </div>

              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas fa-heart"></i>
                  Status de Adoção
                </div>
                <div class="detail-value">
                  <p-tag 
                    [value]="getAdoptionTagText(cat.adoptionStatus)" 
                    [severity]="getAdoptionTagSeverity(cat.adoptionStatus)">
                  </p-tag>
                </div>
              </div>

              <div class="detail-card">
                <div class="detail-label">
                  <i class="fas fa-cut"></i>
                  Status de Castração
                </div>
                <div class="detail-value">
                  <p-tag 
                    *ngIf="!loadingSterilizations"
                    [value]="getSterilizationStatusText()" 
                    [severity]="getSterilizationStatusSeverity()">
                  </p-tag>
                  <span *ngIf="loadingSterilizations">
                    <i class="fas fa-spinner fa-spin"></i> Carregando...
                  </span>
                </div>
              </div>

              <div class="detail-card" *ngIf="getSterilizationDate()">
                <div class="detail-label">
                  <i class="fas fa-calendar-check"></i>
                  Data de Castração
                </div>
                <div class="detail-value">{{ getSterilizationDate() }}</div>
              </div>

              <div class="detail-card full-width" *ngIf="hasSterilizationNotes()">
                <div class="detail-label">
                  <i class="fas fa-notes-medical"></i>
                  Observações de Castração
                </div>
                <div class="detail-value notes-text">{{ getSterilizationNotes() }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Aba de Anotações -->
        <div *ngIf="activeTab === 'notes'" class="tab-pane">
          <div class="notes-container">
            <!-- Formulário para nova anotação -->
            <div class="notes-form" *ngIf="showAddNoteForm">
              <h4><i class="fas fa-plus-circle"></i> Nova Anotação</h4>
              <div class="form-group">
                <label for="noteText">Texto da Anotação:</label>
                <textarea
                  id="noteText"
                  [(ngModel)]="newNoteText"
                  class="note-textarea"
                  rows="6"
                  placeholder="Digite sua anotação aqui...">
                </textarea>
              </div>
              <div class="form-actions">
                <app-generic-button 
                  [config]="saveNoteButtonConfig"
                  (buttonClick)="saveNote()">
                </app-generic-button>
                <app-generic-button 
                  [config]="cancelButtonConfig"
                  (buttonClick)="cancelAddNote()">
                </app-generic-button>
              </div>
            </div>

            <!-- Lista de anotações -->
            <div class="notes-list">
              <div class="notes-header">
                <h4><i class="fas fa-file-edit"></i> Histórico de Anotações</h4>
                <app-generic-button 
                  *ngIf="!showAddNoteForm"
                  [config]="addNoteButtonConfig"
                  (buttonClick)="startAddNote()">
                </app-generic-button>
              </div>

              <div *ngIf="loadingNotes" class="loading-notes">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                <p>Carregando anotações...</p>
              </div>

              <div *ngIf="!loadingNotes && notes.length === 0" class="empty-notes">
                <i class="fas fa-file" style="font-size: 2rem; color: #6c757d;"></i>
                <p>Nenhuma anotação encontrada para este gato.</p>
              </div>

              <div *ngIf="!loadingNotes && notes.length > 0" class="notes-items">
                <div 
                  *ngFor="let note of notes; trackBy: trackByNoteId" 
                  class="note-item">
                  
                  <!-- Modo visualização -->
                  <div *ngIf="editingNoteId !== note.id" class="note-content">
                    <div class="note-header">
                      <span class="note-date">{{ formatDate(note.date) }}</span>
                      <div class="note-actions">
                        <button 
                          type="button"
                          class="btn-icon"
                          title="Editar anotação"
                          (click)="startEditNote(note)">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button 
                          type="button"
                          class="btn-icon btn-danger"
                          title="Excluir anotação"
                          (click)="confirmDeleteNote(note)">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                    <div class="note-text">{{ note.text }}</div>
                  </div>

                  <!-- Modo edição -->
                  <div *ngIf="editingNoteId === note.id" class="note-edit">
                    <div class="form-group">
                      <textarea
                        [(ngModel)]="editingNoteText"
                        class="note-textarea"
                        rows="6">
                      </textarea>
                    </div>
                    <div class="form-actions">
                      <app-generic-button 
                        [config]="{
                          label: 'Salvar',
                          icon: 'pi-check',
                          size: 'small',
                          loading: savingNote
                        }"
                        (buttonClick)="saveEditNote(note)">
                      </app-generic-button>
                      <app-generic-button 
                        [config]="{
                          label: 'Cancelar',
                          icon: 'pi-times',
                          size: 'small',
                          severity: 'secondary',
                          outlined: true
                        }"
                        (buttonClick)="cancelEditNote()">
                      </app-generic-button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Aba de Adotante -->
        <div *ngIf="activeTab === 'adopter'" class="tab-pane">
          <div class="adopter-container">
            <!-- Loading state -->
            <div *ngIf="loadingAdoption" class="loading-adopter">
              <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
              <p>Carregando informações do adotante...</p>
            </div>

            <!-- No adopter found -->
            <div *ngIf="!loadingAdoption && !adopter" class="empty-adopter">
              <i class="fas fa-user-slash" style="font-size: 2rem; color: #6c757d;"></i>
              <p>Nenhum adotante encontrado para este gato.</p>
            </div>

            <!-- Adopter info -->
            <div *ngIf="!loadingAdoption && adopter" class="adopter-info">
              <!-- Adoption status -->
              <div class="adoption-status-card">
                <div class="status-header">
                  <i class="fas fa-heart"></i>
                  <span>Status da Adoção</span>
                </div>
                <div class="status-content">
                  <p-tag 
                    [value]="getAdoptionStatusLabel()" 
                    [severity]="adoption?.status === 'COMPLETED' ? 'success' : 'warn'">
                  </p-tag>
                  <span class="adoption-date">{{ formatDate(adoption?.adoptionDate) }}</span>
                </div>
              </div>

              <!-- Adopter details -->
              <div class="details-grid">
                <div class="detail-card">
                  <div class="detail-label">
                    <i class="fas fa-user"></i>
                    Nome Completo
                  </div>
                  <div class="detail-value">{{ getAdopterFullName() }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">
                    <i class="fas fa-id-card"></i>
                    CPF
                  </div>
                  <div class="detail-value">{{ formatCpf(adopter.cpf) }}</div>
                </div>

                <div class="detail-card">
                  <div class="detail-label">
                    <i class="fas fa-phone"></i>
                    Telefone
                  </div>
                  <div class="detail-value">{{ formatPhone(adopter.phone) }}</div>
                </div>

                <div class="detail-card" *ngIf="adopter.email">
                  <div class="detail-label">
                    <i class="fas fa-envelope"></i>
                    E-mail
                  </div>
                  <div class="detail-value">{{ adopter.email }}</div>
                </div>

                <div class="detail-card" *ngIf="adopter.instagram">
                  <div class="detail-label">
                    <i class="fab fa-instagram"></i>
                    Instagram
                  </div>
                  <div class="detail-value">{{ adopter.instagram }}</div>
                </div>

                <div class="detail-card full-width">
                  <div class="detail-label">
                    <i class="fas fa-map-marker-alt"></i>
                    Endereço
                  </div>
                  <div class="detail-value">{{ adopter.address }}</div>
                </div>

                <div class="detail-card" *ngIf="adopter.registrationDate">
                  <div class="detail-label">
                    <i class="fas fa-calendar-plus"></i>
                    Data de Cadastro
                  </div>
                  <div class="detail-value">{{ formatDate(adopter.registrationDate) }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <div class="action-buttons">
        <app-generic-button 
          *ngIf="cat?.adoptionStatus === 'NAO_ADOTADO'"
          [config]="adoptButtonConfig"
          (buttonClick)="onAdoptCat()">
        </app-generic-button>
        
        <app-generic-button 
          [config]="editButtonConfig"
          (buttonClick)="onEditCat()">
        </app-generic-button>
        
        <app-generic-button 
          [config]="deleteButtonConfig"
          (buttonClick)="onDeleteCat()">
        </app-generic-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Adoção -->
<app-adoption-modal
  [(visible)]="showAdoptionModal"
  [cat]="cat"
  (adoptionCreated)="onAdoptionCreated()">
</app-adoption-modal>
